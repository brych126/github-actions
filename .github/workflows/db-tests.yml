name: Run DB Integration Tests

on:
  workflow_dispatch:

jobs:
  db-tests:
    runs-on: ubuntu-latest
    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        ports:
          - 1433:1433
        env:
          ACCEPT_EULA: "Y"
          SA_PASSWORD: "Password1"
        options: >-
          -v ${{ github.workspace }}/DatabaseTests/scripts:/var/opt/mssql/scripts:ro
          --health-cmd="/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P Password1 -Q 'SELECT 1' -C"
          --health-interval=30s
          --health-timeout=10s
          --health-retries=3

    steps:
      - name: List docker containers
        run: |
         docker ps --format "{{.Names}}"
         docker ps -q --filter "ancestor=mcr.microsoft.com/mssql/server:2022-latest"

      - name: ls_1
        run: |
         ls -l -R ${{ github.workspace }}

      - uses: actions/checkout@v4

      # - name: Copy scripts to mounted temp folder
      #   run: cp -r ./DatabaseTests/scripts temp

      - name: ls_2
        run: |
         ls -l -R ${{ github.workspace }}

      - name: Check mounted dir
        run: docker exec -i $(docker ps -q --filter "ancestor=mcr.microsoft.com/mssql/server:2022-latest") ls /var/opt/mssql/scripts